<!DOCTYPE html>
<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/binaryheap.js?v=0"></script>
    <script src="js/simulation.js?v=0"></script>
    <script src="js/graph.js?v=0"></script>
  </head>
  <!-- <body style="background-color: black;"> -->
  <body>
    <div id="data" style="display: inline-block;"></div>

<script type="text/javascript">
var board = new InfiniteBoard(1);
var sim = new Simulation(board);
sim.alpha = 0.8;
sim.mu = 1.0;
sim.static_types = [S2Z, I2R];
sim.motion_types = [S2Z];

var mins = {x: 0, y: 0};
var maxs = {x: 0, y: 0};

var width = 500;
var height = 500;
var bx = 16;
var by = bx;
var sites = [];

var svg = d3.select("#data")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

var xscale = d3.scale.linear().domain([-bx/2, bx/2]).range([0, width]);
var yscale = d3.scale.linear().domain([-by/2, by/2]).range([height, 0]);
var cells = svg.selectAll('rect').data(sim.sites);

function fillfunc(d) {
    if (d.S > 0) return d3.rgb( 0, 255, 0);
    if (d.Z > 0) return d3.rgb( 255, 0, 0);
    if (d.R > 0) return d3.rgb( 0, 0, 0);
}

function update_sites(sites) {
    for (var c in sites){
        var site = sites[c];
        if (site.x < mins.x) mins.x = site.x;
        if (site.y < mins.y) mins.y = site.y;
        if (site.x > maxs.x) maxs.x = site.x;
        if (site.y > maxs.y) maxs.y = site.y;

        svg.append('rect').datum(site)
            .attr("fill", fillfunc)
            .attr("stroke","black")
            .attr("stroke-width", xscale(0.01)-xscale(0))
            .attr("id", function(d) {return d.hash})
            .attr("x", function(d) {return xscale(d.x)})
            .attr("y", function(d) {return yscale(d.y)})
            .attr("width", xscale(1)-xscale(0))
            .attr("height", yscale(0)-yscale(1))
    }

    var zoom = false;
    if (mins.x == -bx/2) { bx = 4*Math.abs(mins.x); by = bx; zoom = true;}
    if (mins.y == -by/2) { by = 4*Math.abs(mins.y); bx = by; zoom = true;}
    if (maxs.x ==  bx/2) { bx = 4*Math.abs(maxs.x); by = bx; zoom = true;}
    if (maxs.y ==  by/2) { by = 4*Math.abs(maxs.y); bx = by; zoom = true;}

    if (zoom == true){
        console.log('zoom');
        xscale = d3.scale.linear().domain([-bx/2, bx/2]).range([0, width]);
        yscale = d3.scale.linear().domain([-by/2, by/2]).range([height, 0]);

        svg.selectAll('rect')
            .transition()
            .attr("stroke-width", xscale(0.01)-xscale(0))
            .attr("x", function(d) {return xscale(d.x)})
            .attr("y", function(d) {return yscale(d.y)})
            .attr("width", xscale(1)-xscale(0))
            .attr("height", yscale(0)-yscale(1))
    }
}

function dostep() {
    var next_time = sim.time + 0.1;
    var csites = [];
    while (sim.time <= next_time) {
        var sites = sim.dostep();
        if (!sites) {
            window.clearInterval(intID);
            return;
        }
        csites = csites.concat(sites);
    }

    update_sites(csites);
}

var intID;
function launch(){
    sim.addZombieSeed(0,0,S2Z);
    update_sites(sim.sites);
    intID = setInterval(dostep, 30);
}

function stop(){
    window.clearInterval(intID);
}
</script>
<input type='button' value='go' onclick='launch();'>
<input type='button' value='stop' onclick='stop();'>
  </body>
</html>
